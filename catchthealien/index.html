<!DOCTYPE html>
<html lang="de">

<head>
  <meta charset="UTF-8">
  <title>Fang das Alien!</title>
  <link rel="icon" href="./images/space_alien.png" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="./css/index.css">
</head>

<body class="bg-dark text-light">

  <div class="container py-5 text-center">

    <!-- Titel -->
    <h1 class="display-4 fw-bold text-neon mb-3">
      <img src="./images/space_alien.png" alt="Alien" style="height: 70px; vertical-align: middle; margin-right: 10px;">
      Fang das Alien!
      <img src="./images/space_alien.png" alt="Alien" style="height: 70px; vertical-align: middle; margin-right: 10px;">
    </h1>

    <!-- Beschreibung -->
    <div class="mb-4 p-3 bg-gradient text-light rounded-3 shadow-lg mx-auto" style="max-width: 600px;">
      <p>Treffe das Alien, bevor die Zeit von 20 Sekunden abl√§uft.<br> Jeder Treffer macht es schneller, setzt den Timer
        zur√ºck und spielt einen Sound. Bei 7 Sekunden ert√∂nt eine Warnung, <b>jetzt hei√üt es schnell sein!</b></p>
    </div>

    <!-- Punkte und Zeit -->
    <div class="mb-3">
      <span class="fs-4">Punkte:</span>
      <span id="score" class="badge bg-info fs-4">0</span>
      <span class="ms-4 fs-4">Zeit:</span>
      <span id="timer" class="badge bg-warning fs-4">20</span>
      <span class="ms-1 fs-4">sek.</span>
    </div>

    <!-- Start- und Reset-Buttons -->
    <div class="mb-4">
      <button id="startButton" class="btn btn-info btn-lg">Neues Spiel</button>
      <button hidden id="resetButton" class="btn btn-danger btn-lg">Reset Highscore</button>
    </div>

    <!-- Startseite -->
    <div class="mb-4">
      <a href="../index.html" class="btn btn-outline-info btn-lg">
        üéÆ Zur√ºck zur Startseite
      </a>
    </div>

    <!-- Spielbereich -->
    <div class="card bg-secondary shadow-lg rounded-4 p-3 mx-auto" style="max-width: 450px;">
      <canvas id="game" width="400" height="400" class="mx-auto d-block"></canvas>
    </div>

    <!-- Highscore -->
    <div class="mt-4">
      <h3>Highscore</h3>
      <table class="table table-dark table-striped w-50 mx-auto" id="highscoreTable">
        <thead>
          <tr>
            <th>Platz</th>
            <th>Name</th>
            <th>Punkte</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>


    </div>
  </div>

  <script>
    const score_display = document.getElementById('score');
    const timer_display = document.getElementById('timer');
    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');

    // Soundeffekte
    const hitSound = new Audio('./sounds/hit.mp3');
    hitSound.volume = 0.5; // Lautst√§rke anpassen
    hitSound.preload = 'auto';
    hitSound.load();

    const warningSound = new Audio('./sounds/countdown.mp3');
    warningSound.volume = 0.5; // Lautst√§rke anpassen
    let warningPlayed = false;

    // Initiale Position des Aliens und Score
    let x = 100, y = 100, score = 0;

    // Startgeschwindigkeit
    let dx = 1.5, dy = 1.5;

    // Sekunden bis Game Over ohne Klick
    let timeLeft = 20;
    let gameRunning = false;
    let clicked = false;

    // Alien-Bild laden
    const img = new Image();
    img.src = './images/space_alien.png';

    // Reset der Zeit auf 20 Sekunden
    function resetTimer() {
      timeLeft = 20;
    }

    // Damit der Sound beim n√§chsten Run wieder spielt
    function resetSound() {
      warningPlayed = false;
      warningSound.pause();
      warningSound.currentTime = 0;

      hitSound.pause();
      hitSound.currentTime = 0;
    }

    // Reset der Geschwindigkeit auf die Startwerte
    function resetSpeed() {
      dx = 1.5;
      dy = 1.5;
    }

    function drawAlien() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      if (img.complete) {
        if (clicked) {
          // Alien gr√∂√üer zeichnen, z.B. 50x50 statt 40x40
          ctx.drawImage(img, x - 35, y - 35, 70, 70);
        } else {
          ctx.drawImage(img, x - 20, y - 20, 40, 40);
        }
      }
    }

    function updatePosition() {
      x += dx;
      y += dy;

      if (x < 20 || x > canvas.width - 20) dx = -dx;
      if (y < 20 || y > canvas.height - 20) dy = -dy;
    }

    function updateTimer() {
      timeLeft -= 0.016; // bei ~60fps ca. 1 Sekunde pro 60 Frames
      timer_display.textContent = Math.max(timeLeft, 0).toFixed(1);

      if (!warningPlayed && timeLeft <= (warningSound.duration + 4)) {
        warningSound.play();
        warningPlayed = true;
      }

      if (timeLeft <= 0) {
        gameOver();
      }
    }

    function gameOver() {
      gameRunning = false;
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      let name = prompt(`Game Over! Punkte: ${score}\nGib deinen Namen ein, du hast 3 Buchstaben ein:`) || "???";
      name = name.substring(0, 3).toUpperCase();
      saveHighscore(name, score);
      loadHighscores();
    }

    function saveHighscore(name, points) {
      let scores = JSON.parse(localStorage.getItem("alienHighscores")) || [];
      scores.push({ name, points });
      scores.sort((a, b) => b.points - a.points);
      scores = scores.slice(0, 10); // nur Top 10 behalten
      localStorage.setItem("alienHighscores", JSON.stringify(scores));
    }

    function loadHighscores() {
      const tableBody = document.querySelector("#highscoreTable tbody");
      tableBody.innerHTML = "";
      let scores = JSON.parse(localStorage.getItem("alienHighscores")) || [];
      scores.forEach((entry, index) => {
        tableBody.innerHTML += `<tr><td>${index + 1}</td><td>${entry.name}</td><td>${entry.points}</td></tr>`;
      });
    }

    canvas.addEventListener('click', e => {
      const rect = canvas.getBoundingClientRect();
      const clickX = e.clientX - rect.left;
      const clickY = e.clientY - rect.top;
      if (Math.hypot(clickX - x, clickY - y) < 20 && gameRunning) {
        score++;
        score_display.textContent = score;

        resetTimer();
        resetSound();

        // Sound abspielen
        hitSound.play();

        // Geschwindigkeit leicht erh√∂hen und position ver√§ndern
        const speed = Math.sqrt(dx * dx + dy * dy) * 1.05;
        const angle = Math.random() * 2 * Math.PI;
        dx = speed * Math.cos(angle);
        dy = speed * Math.sin(angle);

        // Optisches Feedback starten
        clicked = true;
        setTimeout(() => {
          clicked = false;
        }, 200);
      }
    });

    document.getElementById('resetButton').addEventListener('click', () => {
      if (confirm("Bist du sicher, dass du den Highscore zur√ºcksetzen m√∂chtest?")) {
        localStorage.removeItem("alienHighscores");
        loadHighscores();
      }
    });

    document.getElementById('startButton').addEventListener('click', () => {
      score = 0;
      score_display.textContent = score;

      resetTimer();
      resetSound();
      resetSpeed();

      gameRunning = true;
      gameLoop();
    });

    function gameLoop() {
      if (!gameRunning) return;
      drawAlien();
      updatePosition();
      updateTimer();
      requestAnimationFrame(gameLoop);
    }

    loadHighscores();
  </script>
</body>

</html>