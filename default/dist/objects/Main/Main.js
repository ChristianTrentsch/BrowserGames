"use strict";import{GameObject as p}from"../../GameObject.js";import{Camera as d}from"../../Camera.js";import{Input as m}from"../../Input.js";import{Inventory as u}from"../Inventory/Inventory.js";import{events as t,CHANGE_LEVEL as v,HERO_REQUESTS_ACTION as h,TEXTBOX_START as f,TEXTBOX_END as c,HERO_ATTACK_ACTION as R}from"../../Events.js";import{SpriteTextString as x}from"../SpriteTextString/SpriteTextString.js";import{Vector2 as g}from"../../Vector2.js";import{SaveGame as a}from"../../SaveGame.js";import{Tree as C}from"../../levels/parts/Tree/Tree.js";import{Bush as y}from"../../levels/parts/Bush/Bush.js";import{Stone as T}from"../../levels/parts/Stone/Stone.js";import{Equipment as l}from"../Equipment/Equipment.js";export class Main extends p{constructor(e){super(e),this.level=null,this.input=new m,this.camera=new d(new g(0,0)),this.savedResources=[]}ready(){const e=new u;this.addChild(e);const s=new l;this.addChild(s),t.on(v,this,o=>{a.saveLevel(o.levelId),this.setLevel(o)}),t.on(h,this,o=>{if(typeof o.getContent=="function"){const n=o.getContent(),i=new x(n.portraitFrame,n.string);this.addChild(i),t.emit(f);const r=t.on(c,this,()=>{i.destroy(),t.off(r)})}}),t.on(R,this,o=>{if(o instanceof C||o instanceof T||o instanceof y){const n=this.children.find(r=>r instanceof l),i=n?n.getActiveDamage():1;o.healthPoints-=i,this.level&&(this.pushResource(o),a.saveResources(this.level.levelId,this.savedResources))}})}pushResource(e){const s=this.savedResources.find(o=>o.type===e.constructor.name&&o.x===e.position.x&&o.y===e.position.y);s?s.hp=e.healthPoints:this.savedResources.push({type:e.constructor.name,x:e.position.x,y:e.position.y,hp:e.healthPoints})}setLevel(e){this.level&&this.level.destroy(),this.level=e,this.addChild(this.level),this.savedResources=a.loadResources(this.level.levelId)??[]}drawBackground(e){this.level&&this.level.background.drawImage(e,this.level.background.position.x,this.level.background.position.x)}drawObjects(e){this.children.forEach(s=>{s.drawLayer!=="HUD"&&s.draw(e,s.position.x,s.position.x)})}drawForeground(e){this.children.forEach(s=>{s.drawLayer==="HUD"&&s.draw(e,s.position.x,s.position.x)})}}
