"use strict";import{GameObject as l}from"../../GameObject.js";import{Camera as p}from"../../Camera.js";import{Input as d}from"../../Input.js";import{Inventory as m}from"../Inventory/Inventory.js";import{events as t,CHANGE_LEVEL as v,HERO_REQUESTS_ACTION as u,TEXTBOX_START as h,TEXTBOX_END as f,HERO_ATTACK_ACTION as c}from"../../Events.js";import{SpriteTextString as R}from"../SpriteTextString/SpriteTextString.js";import{Vector2 as x}from"../../Vector2.js";import{SaveGame as r}from"../../SaveGame.js";import{Tree as C}from"../../levels/parts/Tree/Tree.js";import{Bush as y}from"../../levels/parts/Bush/Bush.js";import{Stone as T}from"../../levels/parts/Stone/Stone.js";import{Equipment as g}from"../Equipment/Equipment.js";export class Main extends l{constructor(e){super(e),this.level=null,this.input=new d,this.camera=new p(new x(0,0)),this.savedResources=[]}ready(){const e=new m;this.addChild(e);const s=new g;this.addChild(s),t.on(v,this,o=>{r.saveLevel(o.levelId),this.setLevel(o)}),t.on(u,this,o=>{if(typeof o.getContent=="function"){const n=o.getContent(),i=new R(n.portraitFrame,n.string);this.addChild(i),t.emit(h);const a=t.on(f,this,()=>{i.destroy(),t.off(a)})}}),t.on(c,this,o=>{(o instanceof C||o instanceof T||o instanceof y)&&(o.healthPoints-=1,this.level&&(this.pushResource(o),r.saveResources(this.level.levelId,this.savedResources)))})}pushResource(e){const s=this.savedResources.find(o=>o.type===e.constructor.name&&o.x===e.position.x&&o.y===e.position.y);s?s.hp=e.healthPoints:this.savedResources.push({type:e.constructor.name,x:e.position.x,y:e.position.y,hp:e.healthPoints})}setLevel(e){this.level&&this.level.destroy(),this.level=e,this.addChild(this.level),this.savedResources=r.loadResources(this.level.levelId)??[]}drawBackground(e){this.level&&this.level.background.drawImage(e,this.level.background.position.x,this.level.background.position.x)}drawObjects(e){this.children.forEach(s=>{s.drawLayer!=="HUD"&&s.draw(e,s.position.x,s.position.x)})}drawForeground(e){this.children.forEach(s=>{s.drawLayer==="HUD"&&s.draw(e,s.position.x,s.position.x)})}}
