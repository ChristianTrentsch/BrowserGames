"use strict";import{moveTowards as S}from"../../helpers/moveTowards.js";import{TILE_SIZE as T,isSpaceFree as U}from"../../helpers/grid.js";import{STAND_DOWN as D,STAND_LEFT as g,STAND_RIGHT as A,STAND_UP as I,WALK_DOWN as E,WALK_LEFT as O,WALK_RIGHT as v,WALK_UP as L,PICK_UP_DOWN as _}from"./heroAnimations.js";import{events as c,HERO_POSTION as N,HERO_PICKS_UP_ITEM as R,HERO_REQUESTS_ACTION as x,TEXTBOX_START as C,TEXTBOX_END as F,HERO_ATTACK_ACTION as K}from"../../Events.js";import{GameObject as b}from"../../GameObject.js";import{Vector2 as h}from"../../Vector2.js";import{DOWN as m,LEFT as d,RIGHT as l,UP as f}from"../../Input.js";import{Sprite as y}from"../../Sprite.js";import{resources as k}from"../../Resource.js";import{Animations as W}from"../../Animations.js";import{FrameIndexPattern as o}from"../../FrameIndexPattern.js";import{SaveGame as w}from"../../SaveGame.js";export class Hero extends b{constructor(i,n){super(new h(i,n));const s=new y({resource:k.images.shadow,position:new h(-8,-18),frameSize:new h(32,32)});this.addChild(s),this.body=new y({resource:k.images.hero,position:new h(-8,-19),frameSize:new h(32,32),hFrames:3,vFrames:8,frame:1,animations:new W({walkLeft:new o(O),walkDown:new o(E),walkUp:new o(L),walkRight:new o(v),standLeft:new o(g),standDown:new o(D),standUp:new o(I),standRight:new o(A),pickUpDown:new o(_)})}),this.addChild(this.body),this.facingDirection=m,this.destinationPosition=this.position.duplicate(),this.itemPickUpTime=0,this.itemPickUpShell=null,this.isLocked=!1}ready(){c.on(R,this,i=>{this.onPickUpItem(i)}),c.on(C,this,()=>{if(this.isLocked=!0,this.destinationPosition=this.position.duplicate(),this.body.animations)switch(this.facingDirection){case d:this.body.animations.play("standLeft");break;case l:this.body.animations.play("standRight");break;case f:this.body.animations.play("standUp");break;case m:this.body.animations.play("standDown");break}}),c.on(F,this,()=>{this.isLocked=!1})}step(i,n){if(this.isLocked)return;if(this.itemPickUpTime>0){this.workOnItemPickUp(i);return}const s=n.input;if(s.getActionJustPressed("Space")&&this.parent){const t=this.parent.children.find(r=>r.position.matches(this.position.toNeighbor(this.facingDirection)));t&&!(t instanceof Hero)&&(console.log(this.facingDirection,t),c.emit(x,t))}if(s.getActionJustPressed("KeyF")&&this.parent){const t=this.parent.children.find(r=>r.position.matches(this.position.toNeighbor(this.facingDirection)));t&&!(t instanceof Hero)&&(console.log(this.facingDirection,t),c.emit(K,t))}S(this,this.destinationPosition,1)<=0&&this.tryMove(n),this.tryEmitPosition()}tryEmitPosition(){this.lastX===this.position.x&&this.lastY===this.position.y||(this.lastX=this.position.x,this.lastY=this.position.y,this.body.position&&c.emit(N,this.position))}tryMove(i){const n=i.input;if(!n.direction&&this.body.animations){switch(this.facingDirection){case d:this.body.animations.play("standLeft");break;case l:this.body.animations.play("standRight");break;case f:this.body.animations.play("standUp");break;case m:this.body.animations.play("standDown");break}return}let s=this.destinationPosition.x,e=this.destinationPosition.y;const a=T;if(this.body.animations)switch(n.direction){case d:s-=a,this.body.animations.play("walkLeft");break;case l:s+=a,this.body.animations.play("walkRight");break;case f:e-=a,this.body.animations.play("walkUp");break;case m:e+=a,this.body.animations.play("walkDown");break}this.facingDirection=n.direction??this.facingDirection;const t=i.level;if(t){const r=t.walls;if(!r||!this.parent)return;if(r){const P=U(r,s,e),u=this.parent.children.find(p=>p.isSolid&&p.position.x===s&&p.position.y===e);P&&!u&&(this.destinationPosition.x=s,this.destinationPosition.y=e,w.saveHero(t.levelId,this.destinationPosition))}}}onPickUpItem(i){const n=i.position;if(n){this.destinationPosition=n.duplicate(),this.itemPickUpTime=1e3,w.loadSound()==="on"&&i.itemSound.play().catch(a=>console.warn("Sound konnte nicht abgespielt werden:",a));const e=i.image;e&&(this.itemPickUpShell=new b(new h(0,0)),this.itemPickUpShell.addChild(new y({resource:e,position:new h(0,-19)})),this.addChild(this.itemPickUpShell))}}workOnItemPickUp(i){this.itemPickUpTime-=i,this.body.animations&&this.body.animations.play("pickUpDown"),this.itemPickUpShell&&this.itemPickUpTime<=0&&(this.itemPickUpShell.destroy(),this.itemPickUpShell=null)}}
