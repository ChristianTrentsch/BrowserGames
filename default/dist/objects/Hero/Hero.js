"use strict";import{moveTowards as D}from"../../helpers/moveTowards.js";import{TILE_SIZE as p,isSpaceFree as U}from"../../helpers/grid.js";import{STAND_DOWN as _,STAND_LEFT as S,STAND_RIGHT as E,STAND_UP as g,WALK_DOWN as I,WALK_LEFT as L,WALK_RIGHT as O,WALK_UP as R,PICK_UP_DOWN as v,ATTACK_WALK_DOWN as N,ATTACK_WALK_RIGHT as K,ATTACK_WALK_UP as W,ATTACK_WALK_LEFT as C}from"./heroAnimations.js";import{events as c,HERO_POSTION as G,HERO_PICKS_UP_ITEM as x,HERO_REQUESTS_ACTION as H,TEXTBOX_START as M,TEXTBOX_END as F,HERO_ATTACK_ACTION as X,HERO_CHANGE_EQUIPMENT as Y}from"../../Events.js";import{GameObject as T}from"../../GameObject.js";import{Vector2 as h}from"../../Vector2.js";import{DOWN as l,LEFT as f,RIGHT as k,UP as w}from"../../Input.js";import{Sprite as y}from"../../Sprite.js";import{resources as u}from"../../Resource.js";import{Animations as j}from"../../Animations.js";import{FrameIndexPattern as e}from"../../FrameIndexPattern.js";import{SaveGame as b}from"../../SaveGame.js";import{INVENTORY_ITEMS as B}from"../Inventory/Inventory.js";import{Attack as P}from"../Animations/Attack.js";import{Tree as J}from"../../levels/parts/Tree/Tree.js";import{Stone as Q}from"../../levels/parts/Stone/Stone.js";import{Bush as V}from"../../levels/parts/Bush/Bush.js";export class Hero extends T{constructor(i,s){super(new h(i,s));const n=new y({resource:u.images.shadow,position:new h(-8,-18),frameSize:new h(32,32)});this.addChild(n),this.body=new y({resource:u.images.hero,position:new h(-8,-19),frameSize:new h(32,32),hFrames:3,vFrames:12,frame:1,animations:new j({walkLeft:new e(L),walkDown:new e(I),walkUp:new e(R),walkRight:new e(O),standLeft:new e(S),standDown:new e(_),standUp:new e(g),standRight:new e(E),pickUpDown:new e(v),attackWalkDown:new e(N),attackWalkRight:new e(K),attackWalkUp:new e(W),attackWalkLeft:new e(C)})}),this.addChild(this.body),this.facingDirection=l,this.destinationPosition=this.position.duplicate(),this.itemPickUpTime=0,this.itemPickUpShell=null,this.isLocked=!1}ready(){c.on(x,this,i=>{this.onPickUpItem(i)}),c.on(M,this,()=>{this.isLocked=!0}),c.on(F,this,()=>{this.isLocked=!1})}step(i,s){if(this.isLocked){if(this.body.animations)switch(this.facingDirection){case f:this.body.animations.play("standLeft");break;case k:this.body.animations.play("standRight");break;case w:this.body.animations.play("standUp");break;case l:this.body.animations.play("standDown");break}return}if(this.itemPickUpTime>0){this.workOnItemPickUp(i);return}const n=s.input;if(n.getActionJustPressed("Space")&&this.parent){const t=this.parent.children.find(r=>r.position.matches(this.position.toNeighbor(this.facingDirection)));t&&!(t instanceof Hero)&&c.emit(H,t)}if(n.getActionJustPressed("KeyF")){const t=b.loadEquipment(),r=t.findIndex(o=>o.active===!0);let d;if(t[r]&&t[r].name){switch(t[r].name){case"rodPurple":d=new P(this.facingDirection,"rodAttackPurple");break;case"rodRed":d=new P(this.facingDirection,"rodAttackRed");break;default:d=new P(this.facingDirection,t[r].name);break}this.addChild(d)}if(this.parent){const o=this.parent.children.find(A=>A.position.matches(this.position.toNeighbor(this.facingDirection)));o&&(o instanceof J||o instanceof Q||o instanceof V)&&c.emit(X,o)}}n.getActionJustPressed("KeyQ")&&c.emit(Y,this),D(this,this.destinationPosition,1)<=0&&this.tryMove(s),this.tryEmitPosition()}tryEmitPosition(){this.lastX===this.position.x&&this.lastY===this.position.y||(this.lastX=this.position.x,this.lastY=this.position.y,this.body.position&&c.emit(G,this.position))}tryMove(i){const s=i.input;if(!s.direction&&this.body.animations){switch(this.facingDirection){case f:this.body.animations.play("standLeft");break;case k:this.body.animations.play("standRight");break;case w:this.body.animations.play("standUp");break;case l:this.body.animations.play("standDown");break}return}let n=this.destinationPosition.x,a=this.destinationPosition.y;if(this.body.animations)switch(s.direction){case f:n-=p,this.body.animations.play("walkLeft");break;case k:n+=p,this.body.animations.play("walkRight");break;case w:a-=p,this.body.animations.play("walkUp");break;case l:a+=p,this.body.animations.play("walkDown");break}this.facingDirection=s.direction??this.facingDirection;const m=i.level;if(m){const t=m.walls;if(!t||!this.parent)return;if(t){const r=U(t,n,a),d=this.parent.children.find(o=>o.isSolid&&o.position.x===n&&o.position.y===a);r&&!d&&(this.destinationPosition.x=n,this.destinationPosition.y=a,b.saveHero(m.levelId,this.destinationPosition))}}}onPickUpItem(i){const s=i.position;if(s){this.destinationPosition=s.duplicate(),this.itemPickUpTime=1e3,B.includes(i.imageKey)&&(this.itemPickUpTime=300),b.loadSound()==="on"&&i.itemSound.play().catch(m=>console.warn("Sound konnte nicht abgespielt werden:",m));const a=i.image;a&&(this.itemPickUpShell=new T(new h(0,0)),this.itemPickUpShell.addChild(new y({resource:a,position:new h(0,-19)})),this.addChild(this.itemPickUpShell))}}workOnItemPickUp(i){this.itemPickUpTime-=i,this.body.animations&&this.body.animations.play("pickUpDown"),this.itemPickUpShell&&this.itemPickUpTime<=0&&(this.itemPickUpShell.destroy(),this.itemPickUpShell=null)}}
