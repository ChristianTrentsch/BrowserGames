"use strict";import{moveTowards as u}from"../../helpers/moveTowards.js";import{TILE_SIZE as m,isSpaceFree as A}from"../../helpers/grid.js";import{STAND_DOWN as U,STAND_LEFT as D,STAND_RIGHT as S,STAND_UP as _,WALK_DOWN as E,WALK_LEFT as g,WALK_RIGHT as L,WALK_UP as I,PICK_UP_DOWN as O,ATTACK_WALK_DOWN as R,ATTACK_WALK_RIGHT as K,ATTACK_WALK_UP as v,ATTACK_WALK_LEFT as N}from"./heroAnimations.js";import{events as a,HERO_POSTION as W,HERO_PICKS_UP_ITEM as C,HERO_REQUESTS_ACTION as G,TEXTBOX_START as H,TEXTBOX_END as F,HERO_ATTACK_ACTION as M,HERO_CHANGE_EQUIPMENT as x}from"../../Events.js";import{GameObject as b}from"../../GameObject.js";import{Vector2 as r}from"../../Vector2.js";import{DOWN as p,LEFT as f,RIGHT as k,UP as w}from"../../Input.js";import{Sprite as y}from"../../Sprite.js";import{resources as P}from"../../Resource.js";import{Animations as X}from"../../Animations.js";import{FrameIndexPattern as t}from"../../FrameIndexPattern.js";import{SaveGame as T}from"../../SaveGame.js";import{SwordSlash as j}from"../Animations/SwordSlash.js";export class Hero extends b{constructor(i,s){super(new r(i,s));const e=new y({resource:P.images.shadow,position:new r(-8,-18),frameSize:new r(32,32)});this.addChild(e),this.body=new y({resource:P.images.hero,position:new r(-8,-19),frameSize:new r(32,32),hFrames:3,vFrames:12,frame:1,animations:new X({walkLeft:new t(g),walkDown:new t(E),walkUp:new t(I),walkRight:new t(L),standLeft:new t(D),standDown:new t(U),standUp:new t(_),standRight:new t(S),pickUpDown:new t(O),attackWalkDown:new t(R),attackWalkRight:new t(K),attackWalkUp:new t(v),attackWalkLeft:new t(N)})}),this.addChild(this.body),this.facingDirection=p,this.destinationPosition=this.position.duplicate(),this.itemPickUpTime=0,this.itemPickUpShell=null,this.isLocked=!1}ready(){a.on(C,this,i=>{this.onPickUpItem(i)}),a.on(H,this,()=>{this.isLocked=!0}),a.on(F,this,()=>{this.isLocked=!1})}step(i,s){if(this.isLocked){if(this.body.animations)switch(this.facingDirection){case f:this.body.animations.play("standLeft");break;case k:this.body.animations.play("standRight");break;case w:this.body.animations.play("standUp");break;case p:this.body.animations.play("standDown");break}return}if(this.itemPickUpTime>0){this.workOnItemPickUp(i);return}const e=s.input;if(e.getActionJustPressed("Space")&&this.parent){const o=this.parent.children.find(c=>c.position.matches(this.position.toNeighbor(this.facingDirection)));o&&!(o instanceof Hero)&&a.emit(G,o)}if(e.getActionJustPressed("KeyF")){const o=new j(this.position,this.facingDirection);if(this.addChild(o),this.parent){const c=this.parent.children.find(d=>d.position.matches(this.position.toNeighbor(this.facingDirection)));c&&a.emit(M,c)}}e.getActionJustPressed("KeyQ")&&a.emit(x,this),u(this,this.destinationPosition,1)<=0&&this.tryMove(s),this.tryEmitPosition()}tryEmitPosition(){this.lastX===this.position.x&&this.lastY===this.position.y||(this.lastX=this.position.x,this.lastY=this.position.y,this.body.position&&a.emit(W,this.position))}tryMove(i){const s=i.input;if(!s.direction&&this.body.animations){switch(this.facingDirection){case f:this.body.animations.play("standLeft");break;case k:this.body.animations.play("standRight");break;case w:this.body.animations.play("standUp");break;case p:this.body.animations.play("standDown");break}return}let e=this.destinationPosition.x,n=this.destinationPosition.y;if(this.body.animations)switch(s.direction){case f:e-=m,this.body.animations.play("walkLeft");break;case k:e+=m,this.body.animations.play("walkRight");break;case w:n-=m,this.body.animations.play("walkUp");break;case p:n+=m,this.body.animations.play("walkDown");break}this.facingDirection=s.direction??this.facingDirection;const h=i.level;if(h){const o=h.walls;if(!o||!this.parent)return;if(o){const c=A(o,e,n),d=this.parent.children.find(l=>l.isSolid&&l.position.x===e&&l.position.y===n);c&&!d&&(this.destinationPosition.x=e,this.destinationPosition.y=n,T.saveHero(h.levelId,this.destinationPosition))}}}onPickUpItem(i){const s=i.position;if(s){this.destinationPosition=s.duplicate(),this.itemPickUpTime=1e3,(i.imageKey==="treeRessource"||i.imageKey==="stoneRessource"||i.imageKey==="bushRessource")&&(this.itemPickUpTime=300),T.loadSound()==="on"&&i.itemSound.play().catch(h=>console.warn("Sound konnte nicht abgespielt werden:",h));const n=i.image;n&&(this.itemPickUpShell=new b(new r(0,0)),this.itemPickUpShell.addChild(new y({resource:n,position:new r(0,-19)})),this.addChild(this.itemPickUpShell))}}workOnItemPickUp(i){this.itemPickUpTime-=i,this.body.animations&&this.body.animations.play("pickUpDown"),this.itemPickUpShell&&this.itemPickUpTime<=0&&(this.itemPickUpShell.destroy(),this.itemPickUpShell=null)}}
