"use strict";import{moveTowards as u}from"../../helpers/moveTowards.js";import{TILE_SIZE as U,isSpaceFree as S}from"../../helpers/grid.js";import{STAND_DOWN as T,STAND_LEFT as D,STAND_RIGHT as I,STAND_UP as E,WALK_DOWN as _,WALK_LEFT as g,WALK_RIGHT as v,WALK_UP as L,PICK_UP_DOWN as A}from"./heroAnimations.js";import{events as h,HERO_POSTION as O,HERO_PICKS_UP_ITEM as N,HERO_REQUESTS_ACTION as R,TEXTBOX_START as x,TEXTBOX_END as C}from"../../Events.js";import{GameObject as f}from"../../GameObject.js";import{Vector2 as n}from"../../Vector2.js";import{DOWN as l,LEFT as w,RIGHT as k,UP as P}from"../../Input.js";import{Sprite as d}from"../../Sprite.js";import{resources as y}from"../../Resource.js";import{Animations as F}from"../../Animations.js";import{FrameIndexPattern as s}from"../../FrameIndexPattern.js";import{SaveGame as H}from"../../SaveGame.js";export class Hero extends f{constructor(i,e){super(new n(i,e));const t=new d({resource:y.images.shadow,position:new n(-8,-18),frameSize:new n(32,32)});this.addChild(t),this.body=new d({resource:y.images.hero,position:new n(-8,-19),frameSize:new n(32,32),hFrames:3,vFrames:8,frame:1,animations:new F({walkLeft:new s(g),walkDown:new s(_),walkUp:new s(L),walkRight:new s(v),standLeft:new s(D),standDown:new s(T),standUp:new s(E),standRight:new s(I),pickUpDown:new s(A)})}),this.addChild(this.body),this.facingDirection=l,this.destinationPosition=this.position.duplicate(),this.itemPickUpTime=0,this.itemPickUpShell=null,this.isLocked=!1}ready(){h.on(N,this,i=>{this.onPickUpItem(i)}),h.on(x,this,()=>{this.isLocked=!0}),h.on(C,this,()=>{this.isLocked=!1})}step(i,e){const t=e.level;if(t&&H.saveHero(t.levelId,this.destinationPosition),this.isLocked)return;if(this.itemPickUpTime>0){this.workOnItemPickUp(i);return}if(e.input.getActionJustPressed("Space")&&this.parent){const a=this.parent.children.find(c=>c.position.matches(this.position.toNeighbor(this.facingDirection)));a&&h.emit(R,a)}u(this,this.destinationPosition,1)<=0&&this.tryMove(e),this.tryEmitPosition()}tryEmitPosition(){this.lastX===this.position.x&&this.lastY===this.position.y||(this.lastX=this.position.x,this.lastY=this.position.y,this.body.position&&h.emit(O,this.position))}tryMove(i){const e=i.input;if(!e.direction&&this.body.animations){switch(this.facingDirection){case w:this.body.animations.play("standLeft");break;case k:this.body.animations.play("standRight");break;case P:this.body.animations.play("standUp");break;case l:this.body.animations.play("standDown");break}return}let t=this.destinationPosition.x,o=this.destinationPosition.y;const r=U;if(this.body.animations)switch(e.direction){case w:t-=r,this.body.animations.play("walkLeft");break;case k:t+=r,this.body.animations.play("walkRight");break;case P:o-=r,this.body.animations.play("walkUp");break;case l:o+=r,this.body.animations.play("walkDown");break}this.facingDirection=e.direction??this.facingDirection;const m=i.level;if(m){const a=m.walls;if(!a||!this.parent)return;if(a){const c=S(a,t,o),b=this.parent.children.find(p=>p.isSolid&&p.position.x===t&&p.position.y===o);c&&!b&&(this.destinationPosition.x=t,this.destinationPosition.y=o)}}}onPickUpItem(i){const e=i.position;if(e){this.destinationPosition=e.duplicate(),this.itemPickUpTime=1e3;const t=i.image;t&&(this.itemPickUpShell=new f(new n(0,0)),this.itemPickUpShell.addChild(new d({resource:t,position:new n(0,-19)})),this.addChild(this.itemPickUpShell))}}workOnItemPickUp(i){this.itemPickUpTime-=i,this.body.animations&&this.body.animations.play("pickUpDown"),this.itemPickUpShell&&this.itemPickUpTime<=0&&(this.itemPickUpShell.destroy(),this.itemPickUpShell=null)}}
